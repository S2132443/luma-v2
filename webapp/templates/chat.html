{% extends "base.html" %}

{% block title %}Chat - Luma Bot{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="chat-header">
        <h1>Chat with Luma</h1>
        <div class="user-info">
            <span>Default User ID: <strong>web_user</strong></span>
        </div>
    </div>

    <div class="chat-messages" id="chat-messages">
        <!-- Messages will be loaded here -->
        <div class="message bot-message">
            <div class="message-content">
                Hello! I'm Luma, your AI assistant. How can I help you today?
            </div>
            <div class="message-timestamp"></div>
        </div>
    </div>

    <div class="chat-input-area">
        <div class="input-row">
            <!-- Hidden file input -->
            <input type="file" id="document-upload" name="document" accept=".pdf,.xlsx,.xls,.txt,.json,.csv" style="display: none;">

            <!-- Paperclip button for file upload -->
            <button type="button" id="upload-btn" class="file-upload-btn" title="Upload document">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 15C21 19.9706 16.9706 24 12 24C7.02944 24 3 19.9706 3 15C3 10.0294 7.02944 6 12 6C14.7614 6 17.0774 7.2967 18.5 9.2C18.3156 6.3616 15.5626 4 12 4C6.47715 4 2 8.47715 2 14C2 19.5228 6.47715 24 12 24C17.5228 24 22 19.5228 22 14C22 13.3494 21.9318 12.7176 21.8014 12.1094C21.6461 12.419 21.4471 12.7052 21.2044 12.9538C20.9618 13.2023 20.6792 13.405 20.3698 13.5513C20.0604 13.6976 19.7292 13.7847 19.3918 13.8081C19.0544 13.8314 18.7164 13.7906 18.4 13.69C18.0836 13.5894 17.7952 13.4315 17.5575 13.2284C17.3198 13.0253 17.1388 12.7815 17.0276 12.5138C16.9163 12.2462 16.8777 11.9604 16.9148 11.6765C16.9518 11.3927 17.0635 11.1169 17.24 10.87C17.4165 10.6231 17.6524 10.412 17.93 10.25C18.2076 10.088 18.5191 9.9782 18.8478 9.9276C19.1765 9.877 19.5131 9.8868 19.8388 9.9565C20.1645 10.0261 20.4702 10.1542 20.7392 10.3337C21.0082 10.5131 21.2331 10.7403 21.4 11C21.5836 10.6373 21.6895 10.2432 21.7129 9.8401C21.7362 9.43701 21.6766 9.03198 21.5374 8.64812C21.3982 8.26425 21.182 7.90826 20.902 7.59991C20.622 7.29156 20.2836 7.03647 19.906 6.84882C19.5284 6.66118 19.1189 6.54423 18.6999 6.5045C18.2809 6.46476 17.8599 6.50307 17.46 6.61764C17.06 6.73221 16.6885 6.92059 16.3659 7.17193C16.0433 7.42327 15.7764 7.7318 15.58 8C15.3836 8.2682 15.2613 8.57839 15.2223 8.9044C15.1833 9.23041 15.2287 9.56177 15.3542 9.87C15.1782 9.7814 15.0197 9.6616 14.8859 9.51605C14.752 9.37051 14.6451 9.20183 14.57 9C14.3222 8.3624 14.3222 7.6776 14.57 7C14.8178 6.3224 15.303 5.7575 15.935 5.4187C16.567 5.0799 17.294 5.0001 18 5.2C18.706 5.3999 19.3178 5.8624 19.7 6.5C20.0822 7.1376 20.2022 7.8776 20.04 8.58C19.8778 9.2824 19.4454 9.8912 18.84 10.27C18.2346 10.6488 17.5 10.76 16.8 10.58C16.1 10.4 15.5178 9.9624 15.2 9.38C14.8822 8.7976 14.8822 8.1376 15.2 7.58" stroke="currentColor" stroke-width="2"/>
                </svg>
            </button>

            <input type="text" id="message-input" placeholder="Type your message here..." />
            <button type="button" id="send-btn">Send</button>
        </div>
        <div class="file-info" id="file-info"></div>
    </div>
</div>

<style>
.chat-container {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 150px);
    max-width: 800px;
    margin: 0 auto;
    padding: 1rem;
}

.chat-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border-color);
}

.user-info {
    font-size: 0.9rem;
    color: var(--text-secondary);
}

.chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    background: rgba(26, 32, 44, 0.5);
    border-radius: 8px;
    margin-bottom: 1rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.message {
    max-width: 80%;
    padding: 0.75rem;
    border-radius: 8px;
    position: relative;
}

.user-message {
    align-self: flex-end;
    background: rgba(102, 126, 234, 0.3);
    border-bottom-right-radius: 0;
}

.bot-message {
    align-self: flex-start;
    background: rgba(45, 55, 72, 0.8);
    border-bottom-left-radius: 0;
}

.message-content {
    word-wrap: break-word;
}

.message-timestamp {
    font-size: 0.75rem;
    color: var(--text-secondary);
    text-align: right;
    margin-top: 0.25rem;
}

.chat-input-area {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.file-upload-section {
    background: rgba(45, 55, 72, 0.9);
    padding: 1rem;
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

.file-upload-section label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--text-secondary);
    font-weight: 500;
}

.file-upload-section input[type="file"] {
    margin-bottom: 0.5rem;
    width: 100%;
}

.file-info {
    font-size: 0.85rem;
    color: var(--text-secondary);
    margin-top: 0.5rem;
}

.input-row {
    display: flex;
    gap: 0.5rem;
    align-items: flex-end;
}

#message-input {
    flex: 1;
    padding: 0.75rem;
    background: rgba(26, 32, 44, 0.8);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    color: var(--text-primary);
    font-family: inherit;
    font-size: 1rem;
}

.file-upload-btn {
    background: transparent;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    color: var(--text-primary);
    padding: 0.75rem;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.file-upload-btn:hover {
    background: rgba(102, 126, 234, 0.3);
    border-color: var(--primary-color);
}

.file-upload-btn svg {
    width: 20px;
    height: 20px;
    pointer-events: none;
}

#message-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
}

#send-btn, #upload-btn {
    background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
    color: white;
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    transition: all 0.3s ease;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

#send-btn:hover, #upload-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

@media (max-width: 768px) {
    .chat-container {
        height: calc(100vh - 180px);
        padding: 0.5rem;
    }
    
    .message {
        max-width: 90%;
    }
    
    .input-row {
        flex-direction: column;
    }
    
    #send-btn {
        align-self: flex-end;
    }
}
</style>

<script>
// Chat functionality with backend integration and message persistence
document.addEventListener('DOMContentLoaded', function() {
    const chatMessages = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const uploadBtn = document.getElementById('upload-btn'); // This is now the paperclip button
    const documentUpload = document.getElementById('document-upload');
    const fileInfo = document.getElementById('file-info');

    // Load chat history from localStorage
    function loadChatHistory() {
        const chatHistory = JSON.parse(localStorage.getItem('chatHistory') || '[]');
        chatMessages.innerHTML = ''; // Clear existing messages

        // Add the default welcome message only if there's no history
        if (chatHistory.length === 0) {
            const welcomeMessage = document.createElement('div');
            welcomeMessage.classList.add('message', 'bot-message');
            welcomeMessage.innerHTML = `
                <div class="message-content">Hello! I'm Luma, your AI assistant. How can I help you today?</div>
                <div class="message-timestamp"></div>
            `;
            chatMessages.appendChild(welcomeMessage);
        } else {
            // Add all messages from history
            chatHistory.forEach(function(msg) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message');
                messageDiv.classList.add(msg.sender + '-message');

                messageDiv.innerHTML = `
                    <div class="message-content">${msg.content}</div>
                    <div class="message-timestamp">${msg.timestamp}</div>
                `;

                chatMessages.appendChild(messageDiv);
            });
        }

        // Scroll to bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Save message to localStorage
    function saveMessage(content, sender) {
        const chatHistory = JSON.parse(localStorage.getItem('chatHistory') || '[]');
        const now = new Date();
        const timestamp = now.toLocaleTimeString();

        chatHistory.push({
            content: content,
            sender: sender,
            timestamp: timestamp
        });

        // Limit history to keep only the last 50 messages to prevent localStorage bloat
        if (chatHistory.length > 50) {
            chatHistory.shift();
        }

        localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
    }

    // Clear chat history function
    function clearChatHistory() {
        localStorage.removeItem('chatHistory');
    }

    // Send message function with backend API call
    function sendMessage() {
        const message = messageInput.value.trim();
        if (message) {
            // Add user message to chat and save to localStorage
            addMessageToChat(message, 'user');
            saveMessage(message, 'user');
            messageInput.value = '';

            // Disable input while waiting for response
            messageInput.disabled = true;
            sendBtn.disabled = true;

            // Send to backend API
            fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message,
                    user_id: 'web_user',  // Default user ID for web chat
                    // For web chat, we'll default to not including suggestions unless globally enabled
                    // The backend will check the global setting by default
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    addMessageToChat(`Error: ${data.error}`, 'bot');
                    saveMessage(`Error: ${data.error}`, 'bot');
                } else {
                    addMessageToChat(data.response, 'bot');
                    saveMessage(data.response, 'bot');
                }
            })
            .catch(error => {
                addMessageToChat(`Connection error: ${error.message}`, 'bot');
                saveMessage(`Connection error: ${error.message}`, 'bot');
            })
            .finally(() => {
                // Re-enable input
                messageInput.disabled = false;
                sendBtn.disabled = false;
                messageInput.focus();
            });
        }
    }

    // Add message to chat UI
    function addMessageToChat(content, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message');
        messageDiv.classList.add(sender + '-message');

        const now = new Date();
        const timestamp = now.toLocaleTimeString();

        messageDiv.innerHTML = `
            <div class="message-content">${content}</div>
            <div class="message-timestamp">${timestamp}</div>
        `;

        chatMessages.appendChild(messageDiv);

        // Scroll to bottom
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Event listeners
    sendBtn.addEventListener('click', sendMessage);

    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    // File upload handling - clicking the paperclip button opens the file dialog
    uploadBtn.addEventListener('click', function() {
        documentUpload.click();
    });

    // Handle file selection
    documentUpload.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            const file = e.target.files[0];
            fileInfo.textContent = `Selected file: ${file.name} (${(file.size / 1024).toFixed(2)} KB). Uploading...`;

            // Create FormData for file upload
            const formData = new FormData();
            formData.append('document', file);
            formData.append('user_id', 'web_user');

            // Disable upload button during upload
            uploadBtn.disabled = true;

            // Send file to backend
            fetch('/api/upload_document', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    fileInfo.textContent = `Successfully uploaded ${file.name}. Content added to memories.`;
                } else {
                    fileInfo.textContent = `Error: ${data.error}`;
                }
            })
            .catch(error => {
                fileInfo.textContent = `Upload error: ${error.message}`;
            })
            .finally(() => {
                // Clear the file input and re-enable button after a short delay
                setTimeout(() => {
                    documentUpload.value = '';
                    uploadBtn.disabled = false;
                    // Clear the file info after a few seconds
                    setTimeout(() => {
                        fileInfo.textContent = '';
                    }, 3000);
                }, 500);
            });
        }
    });

    // Load chat history on page load
    loadChatHistory();

    // Focus the message input on load
    messageInput.focus();
});
</script>
{% endblock %}